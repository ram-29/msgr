const SOCKET_URL="http://localhost:1337";let btnHeaderSetting,btnHeaderMessage,sidebarList,mainHeader,contentChatboxHeader,contentChatboxList,contentChatboxInput,contentChatboxInputBox,btnChatboxPhoto,btnChatboxFile,btnChatboxEmoji,btnChatboxSend,id,name,SIMPLE,GROUP;const fileTypes=["application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/msword","application/vnd.ms-excel","application/vnd.ms-powerpoint","application/vnd.sun.xml.writer","application/vnd.sun.xml.writer.global","application/vnd.sun.xml.calc","application/vnd.sun.xml.impress","application/pdf","text/plain"],initUpload=(t,e)=>{const n=`filepond-${e.toLowerCase()}`;swal({title:`Upload your ${"IMG"===e?"image/s":"file/s"} here ..`,html:`<input id="${n}" type="file" class="filepond" name="${n}" multiple data-max-files="10"/>`,showCloseButton:!0,showCancelButton:!1,showConfirmButton:!0,focusConfirm:!1,allowOutsideClick:!1,customClass:"mSwal",confirmButtonText:'Upload all <i class="fa fa-upload"></i>',showLoaderOnConfirm:!0,allowOutsideClick:t=>!Swal.isLoading(),preConfirm:async t=>i.getFiles().length?(swal.resetValidationMessage(),i.processFiles()):swal.showValidationMessage("Should have enough files first.")}).then(t=>{});const i=FilePond.create(document.querySelector(`#${n}`),{acceptedFileTypes:"IMG"===e?["image/*"]:fileTypes,instantUpload:!1,server:{url:null,process:(e,n,i,o,a,s,l)=>{switch(o("OK"),t.getAttribute("data-conn")){case"SIMPLE":const e=new SocketIOFileUpload(SIMPLE);e.addEventListener("start",function(t){t.file.meta={threadId:mConn.id,memberId:id,fileType:n.type,createdAt:moment().format("YYYY-MM-DD HH:mm:ss")}}),e.submitFiles([new File([n],n.name)]);break;case"GROUP":const i=new SocketIOFileUpload(GROUP);i.addEventListener("start",function(t){t.file.meta={threadId:mConn.id,memberId:id,fileType:n.type,createdAt:moment().format("YYYY-MM-DD HH:mm:ss")}}),i.submitFiles([new File([n],n.name)])}return{abort:()=>{request.abort(),l()}}}}})},buildURLQuery=t=>Object.entries(t).map(t=>t.map(encodeURIComponent).join("=")).join("&"),initUI=t=>{const e=t.firstElementChild.children[0].src;contentChatboxHeaderImg.setAttribute("src",e);const n=t.firstElementChild.children[1].children[0].textContent;mainHeaderDetailsH4.textContent=n,contentChatboxHeaderDetailsH4.textContent=n,contentChatboxInput.children[0].style.visibility="visible",contentChatboxInput.children[1].style.visibility="visible"},initConn=(t,e)=>{const n=buildURLQuery({id:t,name:e});(SIMPLE=io(`${SOCKET_URL}/simple`,{query:n})).on("connect",t=>{console.log("You connected to Private Messaging")}),SIMPLE.on("chat",e=>{const{uId:n,message:i,timestamp:o}=e,a=contentChatboxHeaderImg.getAttribute("src"),s=`\n            <div class="msgr-main-content-chatbox-list-item">\n                <span>${o}</span>\n\n                <div class="msgr-main-content-chatbox-list-item-details ${n===t?"owner":""}">\n                    <img class="img-circle" src="${a}" alt="User image">\n                    <div class="msgr-main-content-chatbox-list-item-details-content">\n                        <p>${i.trim()}</p>\n                    </div>\n                </div>\n            </div>\n        `;contentChatboxList.insertAdjacentHTML("beforeend",s),contentChatboxList.parentNode.scrollTop=contentChatboxList.parentNode.scrollHeight}),SIMPLE.on("file",e=>{const{member_id:n,filename:i,filepath:o,type:a,created_at:s}=e,l=contentChatboxHeaderImg.getAttribute("src"),r=`\n            <div class="msgr-main-content-chatbox-list-item">\n                <span>${s}</span>\n\n                <div class="msgr-main-content-chatbox-list-item-details ${n===t?"owner":""}">\n                    <img class="img-circle" src="${l}" alt="User image">\n                    <div class="msgr-main-content-chatbox-list-item-details-content">\n                        ${"image"===a?`<img src="${o}" alt="${i}" style="border: 1.5rem solid #09f; border-radius: 2.5rem; max-width:70%;">`:`<p><a href="${o}" target="_blank" style="color:#fff !important; text-decoration:underline;">${i}</a></p>`}\n                    </div>\n                </div>\n            </div>\n        `;contentChatboxList.insertAdjacentHTML("beforeend",r),contentChatboxList.parentNode.scrollTop=contentChatboxList.parentNode.scrollHeight}),SIMPLE.on("disconnect",t=>{console.log("Disconnected to PM"),SIMPLE.disconnect()}),(GROUP=io(`${SOCKET_URL}/group`,{query:n})).on("connect",t=>{console.log("You connected to Group Messaging")}),GROUP.on("chat",e=>{const{uId:n,message:i,timestamp:o}=e,a=`\n            <div class="msgr-main-content-chatbox-list-item">\n                <span>${o}</span>\n\n                <div class="msgr-main-content-chatbox-list-item-details ${n===t?"owner":""}">\n                    <img class="img-circle" src="/img/1.png" alt="User image">\n                    <div class="msgr-main-content-chatbox-list-item-details-content">\n                        <p>${i.trim()}</p>\n                    </div>\n                </div>\n            </div>\n        `;contentChatboxList.insertAdjacentHTML("beforeend",a),contentChatboxList.parentNode.scrollTop=contentChatboxList.parentNode.scrollHeight}),GROUP.on("disconnect",t=>{console.log("Disconnected to GM"),GROUP.disconnect()})};let mConn={};const connect=async(t,e,n)=>{switch(n){case"SIMPLE":SIMPLE.emit("join-room",{id:e}),mConn={id:e,type:"SIMPLE"},btnChatboxPhoto.setAttribute("data-conn","SIMPLE"),btnChatboxFile.setAttribute("data-conn","SIMPLE");const t=$("#tab-image");t.nanogallery2("destroy");const i=await axios.get(`http://localhost:80/msgr/backend/web/api/thread/${e}?expand=images`);t.nanogallery2({items:i.data.images.map(t=>{if(t.file_path)return{src:t.file_path,srct:t.file_thumb,title:t.file_name}}),thumbnailWidth:"auto",thumbnailHeight:100});const o=$("#tab-docs");o.html(""),(await axios.get(`http://localhost:80/msgr/backend/web/api/thread/${e}?expand=docs`)).data.docs.map(t=>{o.append(`\n                    <li style="margin: 1rem 0;">\n                        <a href="${t.file_path}" target="_blank" style="text-decoration:underline;" title="${t.file_name}">${t.file_name}</a> <br/>\n                        <span class="label label-default">${moment(t.created_at).format("MMM. DD, YYYY hh:mm a")}</span>\n                    </li>\n                `)});break;case"GROUP":GROUP.emit("join-room",{id:e}),mConn={id:e,type:"GROUP"},btnChatboxPhoto.setAttribute("data-conn","GROUP"),btnChatboxFile.setAttribute("data-conn","GROUP")}initUI(t)},groupConfirm=t=>{const e=t.parentElement.previousElementSibling.children[1].children[0],n=e.dataset.id,i=e.textContent,o=[{member_id:id,role:"ADMIN"},{member_id:n,role:"MEMBER"}];swal({width:"50rem",type:"question",title:"Please choose an option",focusConfirm:!1,showCloseButton:!0,showCancelButton:!0,showConfirmButton:!0,allowOutsideClick:!1,confirmButtonColor:"#5cb85c",confirmButtonText:`\n            <i class="fa fa-user-plus fa-2x" aria-hidden="true"></i>\n            <br/>Add <strong>${i}</strong> <br/>to a New Group\n        `,confirmButtonAriaLabel:"Add to New Group",cancelButtonColor:"#337ab7",cancelButtonText:`\n            <i class="fa fa-users fa-2x" aria-hidden="true"></i>\n            <br/>Add <strong>${i}</strong> <br/>to an Existing Group\n        `,cancelButtonAriaLabel:"Add to an Existing Group"}).then(t=>{t.value?swal({title:"Please specify a group name",input:"text",inputAttributes:{autocapitalize:"off"},confirmButtonText:"Submit",showLoaderOnConfirm:!0,preConfirm:t=>{if(t)return fetch(`${BK_URL}/api/thread`,{method:"POST",body:JSON.stringify({type:"GROUP",name:t,members:o}),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(async e=>{if(!e.ok)throw new Error(e.statusText);const n=await e.json();return n.result=t,n.members=o,n}).catch(t=>{Swal.showValidationMessage(`Request failed: ${t}`)});Swal.showValidationMessage("Please specify a group name")},allowOutsideClick:()=>!Swal.isLoading()}).then(t=>{console.log(t)}):console.log("Existing Group")})};document.addEventListener("DOMContentLoaded",async t=>{FilePond.registerPlugin(FilePondPluginImageCrop,FilePondPluginImageEdit,FilePondPluginImageExifOrientation,FilePondPluginImagePreview,FilePondPluginImageResize,FilePondPluginImageTransform,FilePondPluginImageValidateSize,FilePondPluginFileEncode,FilePondPluginFileMetadata,FilePondPluginFilePoster,FilePondPluginFileRename,FilePondPluginFileValidateSize,FilePondPluginFileValidateType),btnHeaderSetting=document.querySelector("#btn-header-setting"),btnHeaderMessage=document.querySelector("#btn-header-message"),sidebarList=document.querySelector(".msgr-sidebar-list"),mainHeaderDetailsH4=document.querySelector(".msgr-main-header-details > h4"),contentChatboxHeaderImg=document.querySelector(".msgr-main-content-chatbox-header > img"),contentChatboxHeaderDetailsH4=document.querySelector(".msgr-main-content-chatbox-header-details > h4"),contentChatboxList=document.querySelector(".msgr-main-content-chatbox-list > .os-padding > .os-viewport > .os-content"),contentChatboxInput=document.querySelector(".msgr-main-content-chatbox-input"),contentChatboxInputBox=document.querySelector("#content-chatbox-input-box"),btnChatboxPhoto=document.querySelector("#btn-chatbox-photo"),btnChatboxFile=document.querySelector("#btn-chatbox-file"),btnChatboxEmoji=document.querySelector("#btn-chatbox-emoji"),btnChatboxSend=document.querySelector("#btn-chatbox-send"),swal.mixin({input:"text",confirmButtonText:"Next &rarr;",progressSteps:["1","2"],showCloseButton:!1,allowOutsideClick:!1,showCancelButton:!1}).queue(["Enter ID","Enter Name"]).then(async t=>{const e=t.value.filter(t=>t);void 0!==e&&0!=e.length&&(id="f9c159af-6f58-441d-b26f-a6ab4b497eaf",name="Maria Powell",axios.get(`${BK_URL}/api/member/${id}?expand=threads`).then(t=>{const e=t.data.threads.map(t=>`\n                        <div class="msgr-sidebar-list-item" onClick="connect(this, '${t.id}', '${t.type}')">\n                            <div class="msgr-sidebar-list-item-content">\n                                <img class="img-circle" src="/img/${"GROUP"==t.type?"3":"M"==t.sex?"1":"2"}.png" alt="User image">                        \n                                <div class="msgr-sidebar-list-item-content-details">\n                                    <h4>${t.name}</h4>\n                                    <p>${t.message?t.message.latest:"-"}</p>\n                                </div>\n                            </div>\n            \n                            <div class="msgr-sidebar-list-item-settings">\n                                <span>${t.message?moment(t.message.time).format("ddd"):"-"}</span>\n                                <button type="button" id="btn-list-item-setting" class="btn btn-default btn-sm">\n                                    <i class="fa fa-cog fa-fw"></i>\n                                </button>\n                            </div>\n                        </div>\n                    `).join("");sidebarList.innerHTML=e,OverlayScrollbars(sidebarList,{})}),initConn(id,name),contentChatboxInputBox.addEventListener("keydown",t=>{if(13===t.keyCode&&!t.shiftKey){t.preventDefault();const e=moment().format("MMM DD, YYYY, hh:mm a"),n=t.target.value;"GROUP"==mConn.type&&GROUP.emit("chat",{cId:mConn.id,uId:id,message:n,timestamp:e}),SIMPLE.emit("chat",{cId:mConn.id,uId:id,message:n,timestamp:e}),contentChatboxInputBox.value=""}}))})});